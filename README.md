# Puppet Certificate Management
An attempt at explaining certificate usage in Puppet and how to use an external CA like Thawte, Verisign, etc.

## RTFM list
[X.509](http://en.wikipedia.org/wiki/X.509)


## PuppetDB
/opt/puppet/sbin/puppetdb-ssl-setup

## MCollective

## General
A list of all certificates ever issued by Puppet’s CA can be found in the file $cadir/inventory.txt.


## List of internall generated certificates:
* master.puppetlabs.vm
* pe-internal-broker
* pe-internal-dashboard
* pe-internal-mcollective-servers
* pe-internal-peadmin-mcollective-client
* pe-internal-puppet-console-mcollective-client

## Usefull commands
Run these commands in bash to create a shortcut to view certificates with.
```bash
function viewcert { openssl x509 -in $1 -noout -text; }
function certcompare { vimdiff <(viewcert $1) <(viewcert $2); }
```

## CA Directory disection
Where not specified, just use the viewcert bash function to view a certificate. Anything else is not going to be a certificat and will need a different command.
### Directory layout
```bash
tree  $(puppet config print ssldir)
/etc/puppetlabs/puppet/ssl
├── ca
│   ├── ca_crl.pem
│   ├── ca_crt.pem
│   ├── ca_key.pem
│   ├── ca_pub.pem
│   ├── inventory.txt
│   ├── private
│   │   └── ca.pass
│   ├── requests
│   ├── serial
│   └── signed
│       ├── master.puppetlabs.vm.pem
│       ├── pe-internal-broker.pem
│       ├── pe-internal-dashboard.pem
│       ├── pe-internal-mcollective-servers.pem
│       ├── pe-internal-peadmin-mcollective-client.pem
│       └── pe-internal-puppet-console-mcollective-client.pem
├── certificate_requests
├── certs
│   ├── ca.pem
│   ├── master.puppetlabs.vm.pem
│   ├── pe-internal-broker.pem
│   ├── pe-internal-mcollective-servers.pem
│   ├── pe-internal-peadmin-mcollective-client.pem
│   └── pe-internal-puppet-console-mcollective-client.pem
├── crl.pem
├── private
├── private_keys
│   ├── master.puppetlabs.vm.pem
│   ├── pe-internal-broker.pem
│   ├── pe-internal-mcollective-servers.pem
│   ├── pe-internal-peadmin-mcollective-client.pem
│   └── pe-internal-puppet-console-mcollective-client.pem
└── public_keys
    ├── master.puppetlabs.vm.pem
    ├── pe-internal-broker.pem
    ├── pe-internal-mcollective-servers.pem
    ├── pe-internal-peadmin-mcollective-client.pem
    └── pe-internal-puppet-console-mcollective-client.pem
```
### Individual file analyis

- *ca/ca_crl.pem*
Certificate revocation list, to view this file run:
```bash
openssl crl -in ca/ca_crl.pem -noout -text
```

- *ca/ca_crt.pem*
The CA certificate

- *ca/ca_key.pem*
The CA private key. For the sake of completeness the command to view it is:
```bash
openssl rsa -in ca/ca_key.pem -noout -text
```

- *ca/ca_pub.pem*
The public part of the private key. You can compare it with the private key by doing:
```bash
vimdiff <(openssl rsa -in ca/ca_key.pem -pubout) <(cat ca/ca_pub.pem )
```

- *ca/inventory.txt*
```
This file contains a list of all certificates ever granted. The fields are:
  - Number,
  - Issue date,
  - Expiry date,
  - CN value

- *ca/private/ca.pass*
A password for the CA autogenerated during the puppet install. It goes without saying that this is rather important.

- *ca/requests*
All certificate signing requests will land in this directory and will be .pem files. To view these 

- *ca/serial*
This file is the autoincrement marker for the certificate serial number. Every time a new certificate is issues this will get incremented by one.



TODO
* Write script that uses web api to create csr.
* Use the above script to generate large amount of csr requests
* How to use puppet cert in wireshark to view traffic
