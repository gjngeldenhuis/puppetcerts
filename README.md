# Puppet Certificate Management
An attempt at explaining certificate usage in Puppet and how to use an external CA like Thawte, Verisign, etc.

## RTFM list
[X.509](http://en.wikipedia.org/wiki/X.509)
[Puppet Rest API](http://docs.puppetlabs.com/guides/rest_auth_conf.html)
[openldap cert stuff, usefull](http://www.openldap.org/faq/data/cache/185.html)

## Autosign
/etc/puppetlabs/puppet/autosign.conf
mynode01.example.com
\*.example.com
\*.local

## REST API
To get the master public cert:
curl -k -H "Accept: s" https://master.puppetlabs.vm:8140/production/certificate/ca


## PuppetDB
/opt/puppet/sbin/puppetdb-ssl-setup

## MCollective

## General
A list of all certificates ever issued by Puppet’s CA can be found in the file $cadir/inventory.txt.

## Puppet Faces 
* cert
  * clean
  * fingerprint
  * generate
  * list
  * print
  * revoke
  * sign
  * verify
  * reinventory
* certificate
* certificate\_request
* certificate\_revocation\_list


## Potential bugs
* The --allowd-dns-altnames is not the puppet help cert documentation
* The puppet cert face documentation is based of a man page but the other other cert related pages looks different.


## List of internall generated certificates:
* master.puppetlabs.vm
* pe-internal-broker
* pe-internal-dashboard
* pe-internal-mcollective-servers
* pe-internal-peadmin-mcollective-client
* pe-internal-puppet-console-mcollective-client

## Usefull commands
Run these commands in bash to create a shortcut to view certificates with.
```bash
function viewcert { openssl x509 -in $1 -noout -text; }
function certcompare { vimdiff <(viewcert $1) <(viewcert $2); }
```

## CA Directory disection
Where not specified, just use the viewcert bash function to view a certificate. Anything else is not going to be a certificat and will need a different command.
### Directory layout
```bash
tree  $(puppet config print ssldir)
/etc/puppetlabs/puppet/ssl
├── ca
│   ├── ca_crl.pem
│   ├── ca_crt.pem
│   ├── ca_key.pem
│   ├── ca_pub.pem
│   ├── inventory.txt
│   ├── private
│   │   └── ca.pass
│   ├── requests
│   ├── serial
│   └── signed
│       ├── master.puppetlabs.vm.pem
│       ├── pe-internal-broker.pem
│       ├── pe-internal-dashboard.pem
│       ├── pe-internal-mcollective-servers.pem
│       ├── pe-internal-peadmin-mcollective-client.pem
│       └── pe-internal-puppet-console-mcollective-client.pem
├── certificate_requests
├── certs
│   ├── ca.pem
│   ├── master.puppetlabs.vm.pem
│   ├── pe-internal-broker.pem
│   ├── pe-internal-mcollective-servers.pem
│   ├── pe-internal-peadmin-mcollective-client.pem
│   └── pe-internal-puppet-console-mcollective-client.pem
├── crl.pem
├── private
├── private_keys
│   ├── master.puppetlabs.vm.pem
│   ├── pe-internal-broker.pem
│   ├── pe-internal-mcollective-servers.pem
│   ├── pe-internal-peadmin-mcollective-client.pem
│   └── pe-internal-puppet-console-mcollective-client.pem
└── public_keys
    ├── master.puppetlabs.vm.pem
    ├── pe-internal-broker.pem
    ├── pe-internal-mcollective-servers.pem
    ├── pe-internal-peadmin-mcollective-client.pem
    └── pe-internal-puppet-console-mcollective-client.pem
```
### Individual file analyis

- *ca/ca_crl.pem*
Certificate revocation list, to view this file run:
```bash
openssl crl -in ca/ca_crl.pem -noout -text
```

- *ca/ca_crt.pem*
The CA certificate

- *ca/ca_key.pem*
The CA private key. For the sake of completeness the command to view it is:
```bash
openssl rsa -in ca/ca_key.pem -noout -text
```

- *ca/ca_pub.pem*
The public part of the private key. You can compare it with the private key by doing:
```bash
vimdiff <(openssl rsa -in ca/ca_key.pem -pubout) <(cat ca/ca_pub.pem )
```

- *ca/inventory.txt*
This file contains a list of all certificates ever granted. The fields are:
  - Number,
  - Issue date,
  - Expiry date,
  - CN value

- *ca/private/ca.pass*
A password for the CA autogenerated during the puppet install. It goes without saying that this is rather important.

- *ca/requests*
All certificate signing requests will land in this directory and will be .pem files. To view these requests you can run the following command:
```bash
openssl req -in ca/requests/*.pem -noout -text
```

- *ca/serial*
This file is the autoincrement marker for the certificate serial number. Every time a new certificate is issues this will get incremented by one.

- *ca/signed*
This directory contains all signed certficates. Once you have signed a CSR a signed certificate for the node can be found in this directory matching the node name.

- *certificate_requests
?? Unsure at present, this does not contain CSR requests from agents

- *certs*
This directory contains all of the internal certificates used in puppet. The certificates here match the certificates found in *ca/signed/* except for ca.pem which is not in *ca/signed/* but in *ca/ca_crt.pem* and *ca/signed* contains a certificate for **pe-internal-dashboard**

- *crl.pem*
Is a copy of *ca/ca_crl.pem*

- *private*
It's private, go away. Not sure at present. It remained empty during node requests, so possibly related to *certificate_requests* directory.

- *private_keys*
This directory contains the private keys for all puppet internal certificates.

- *public_keys*
This directory contains the public keys for all interal certificates


TODO
* Write script that uses web api to create csr.
* Use the above script to generate large amount of csr requests
* How to use puppet cert in wireshark to view traffic
* Revoke a certificate to see what changes and capture that in the directory listing
* Completely flesh out file listing and explain each certificate
* List various puppet ssl configuration settings, where and how to get and set them.
* puppet ca list --all   gives an error when run on the master. Why? It should be working out the box?
* There is both a certificate and cert puppet face. Why? And what is the difference?
* Research and explain options found in openssl-exts.cnf file which sets the settings for the puppet ca
can be found at */opt/puppet/share/vendor/ruby/1.9.1/gems/httparty-0.11.0/spec/fixtures/ssl/openssl-exts.cnf*
* Read about perfect forwarding security and how it is applicable to us?

files to investigate
/opt/puppet/lib/ruby/site_ruby/1.9.1/puppet/face/certificate.rb
/opt/puppet/lib/ruby/1.9.1/rubygems/commands/cert_command.rb
/opt/puppet/lib/ruby/site_ruby/1.9.1/puppet/application/cert.rb
/opt/puppet/share/console/applications/certificates
/opt/puppet/share/console-auth/config/certificate_authorization.example.yml

Man Pages to read ( they are displayed when doing puppet help )
/opt/puppet/share/man/man8
puppet-cert
puppet-certificate
puppet-certificate_request
puppet-certificate_revocation_list
